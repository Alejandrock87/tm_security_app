{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Real-Time Transmilenio Map</h1>

<div class="row">
    <div class="col-12">
        <div id="real-time-map" style="height: 600px;"></div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <h2>Transmilenio Stations</h2>
        <ul id="station-list" class="list-group">
            <!-- Stations will be populated here -->
        </ul>
    </div>
    <div class="col-md-6">
        <h2>Your Location</h2>
        <p id="user-location">Waiting for location...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    const socket = io();
    let map;
    let userMarker;
    let stationMarkers = [];

    function initMap() {
        map = L.map('real-time-map').setView([4.6097, -74.0817], 11); // Centered on Bogotá
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        updateStations();
        initializeUserLocation();

        socket.on('update_user_location', (data) => { 
            console.log('Received location update:', data);
            updateUserLocation(data.latitude, data.longitude); 
        });
    }

    function updateStations() {
        console.log("Updating stations...");  // Debug log
        map.setView([4.6097, -74.0817], 11);  // Reset view to Bogotá

        fetch('/api/stations')
            .then(response => response.json())
            .then(data => {
                // Clear existing markers
                stationMarkers.forEach(marker => map.removeLayer(marker));
                stationMarkers = [];

                const stationList = document.getElementById('station-list');

                console.log("Received station data:", data);  // Debug log

                if (data && data.length > 0) {
                    // Add new markers
                    data.forEach(station => {
                        const marker = L.marker([station.latitude, station.longitude], {icon: createStationIcon()}).addTo(map);
                        marker.bindPopup(`<b>${station.name}</b><br>Transmilenio Station`);
                        stationMarkers.push(marker);
                    });

                    // Update station list
                    stationList.innerHTML = data.map(station => `
                        <li class="list-group-item">${station.name}</li>
                    `).join('');
                } else {
                    stationList.innerHTML = '<li class="list-group-item">No station data available</li>';
                }
            })
            .catch(error => {
                console.error('Error fetching stations:', error);  // Debug log
            });
    }

    function createStationIcon() {
        return L.icon({
            iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    }

    function initializeUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const { latitude, longitude } = position.coords;

                if (userMarker) {
                    map.removeLayer(userMarker);
                }

                userMarker = L.marker([latitude, longitude], {
                    icon: L.icon({
                        iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41], 
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);
                map.setView([latitude, longitude], 15);  // Center map on user's location
                userMarker.bindPopup("Your current location");
                
                document.getElementById('user-location').textContent = `Latitude: ${latitude.toFixed(4)}, Longitude: ${longitude.toFixed(4)}`;
                
                // Emit the initial location to the server 
                socket.emit('update_user_location', { latitude, longitude });
                
                // Start watching for location changes
                navigator.geolocation.watchPosition(
                    newPosition => {
                        const { latitude, longitude } = newPosition.coords;
                        console.log('Sending location update:', { latitude, longitude });
                        socket.emit('update_user_location', { latitude, longitude });
                        updateUserLocation(latitude, longitude);
                    },
                    error => console.error('Error watching position:', error),
                    { enableHighAccuracy: true }
                );
            }, error => {
                console.error('Error getting user location:', error);
                document.getElementById('user-location').textContent = 'Unable to get your location. Please enable geolocation.';
            }, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
        } else {
            document.getElementById('user-location').textContent = 'Geolocation is not supported by your browser.';
        }
    }

    function updateUserLocation(latitude, longitude) {
        console.log('Updating user location:', latitude, longitude);
        if (userMarker) {
            userMarker.setLatLng([latitude, longitude]);
            map.setView([latitude, longitude], 15);  // Center map on updated user location
        }
        map.setView([latitude, longitude], 15);  // Center map on updated user location
        document.getElementById('user-location').textContent = `Latitude: ${latitude.toFixed(4)}, Longitude: ${longitude.toFixed(4)}`;
    }

    document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}
