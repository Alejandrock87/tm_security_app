{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <h1 class="mb-4 text-center">Reportar un Incidente</h1>
        <form action="" method="post" novalidate id="incident-form">
            {{ form.hidden_tag() }}
            <div class="mb-3">
                {{ form.incident_type.label(class="form-label") }}
                {{ form.incident_type(class="form-select") }}
                {% for error in form.incident_type.errors %}
                <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>
            <div class="mb-3">
                {{ form.description.label(class="form-label") }}
                {{ form.description(rows=5, class="form-control") }}
                {% for error in form.description.errors %}
                <span class="text-danger">{{ error }}</span>
                {% endfor %}
            </div>
            <div class="mb-3">
                <label for="nearest_station" class="form-label">Estación Transmilenio más cercana</label>
                <input type="text" id="nearest_station" name="nearest_station" class="form-control" readonly>
            </div>
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">
            {{ form.submit(class="btn btn-primary w-100", id="submit-button") }}
        </form>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div id="map" style="height: 400px;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('incident-form');
    const submitButton = document.getElementById('submit-button');
    const latitudeInput = document.getElementById('latitude');
    const longitudeInput = document.getElementById('longitude');
    const nearestStationInput = document.getElementById('nearest_station');

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("La geolocalización no es compatible con este navegador.");
        }
    }

    function showPosition(position) {
        latitudeInput.value = position.coords.latitude;
        longitudeInput.value = position.coords.longitude;
        submitButton.disabled = false;
        
        if (typeof updateMapWithUserLocation === 'function') {
            updateMapWithUserLocation(position.coords.latitude, position.coords.longitude);
        }

        if (typeof findNearestStation === 'function') {
            const nearestStation = findNearestStation(position.coords.latitude, position.coords.longitude);
            nearestStationInput.value = nearestStation;
        }
    }

    function showError(error) {
        switch(error.code) {
            case error.PERMISSION_DENIED:
                alert("El usuario denegó la solicitud de geolocalización.");
                break;
            case error.POSITION_UNAVAILABLE:
                alert("La información de ubicación no está disponible.");
                break;
            case error.TIMEOUT:
                alert("La solicitud para obtener la ubicación del usuario ha expirado.");
                break;
            case error.UNKNOWN_ERROR:
                alert("Ocurrió un error desconocido.");
                break;
        }
    }

    submitButton.disabled = true;
    getLocation();

    form.addEventListener('submit', function(event) {
        if (!latitudeInput.value || !longitudeInput.value) {
            event.preventDefault();
            alert("Por favor, espere a que se determine su ubicación o habilite los servicios de ubicación.");
        }
    });
});
</script>
{% endblock %}
