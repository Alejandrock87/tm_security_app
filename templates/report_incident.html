{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header flex items-center">
        <button onclick="setCurrentScreen('main')" class="btn btn-ghost btn-circle">
            <i data-lucide="arrow-left"></i>
        </button>
        <h2 class="card-title ml-4">Registrar Incidente</h2>
    </div>
    <div class="card-body">
        <form action="{{ url_for('report_incident') }}" method="post" id="incident-form" class="space-y-4">
            {{ form.hidden_tag() }}
            <div class="form-control">
                {{ form.incident_type.label(class="label") }}
                {{ form.incident_type(class="select select-bordered w-full") }}
            </div>
            <div class="form-control">
                {{ form.description.label(class="label") }}
                {{ form.description(rows=5, class="textarea textarea-bordered") }}
            </div>
            <div class="form-control">
                <label for="nearest_station" class="label">Estación Transmilenio más cercana</label>
                <input type="text" id="nearest_station" name="nearest_station" class="input input-bordered" readonly>
            </div>
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">
            {{ form.submit(class="btn btn-primary w-full", id="submit-button") }}
        </form>
    </div>
</div>

<div class="mt-4">
    <div id="map" class="h-64 rounded-box"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('incident-form');
    const submitButton = document.getElementById('submit-button');
    const latitudeInput = document.getElementById('latitude');
    const longitudeInput = document.getElementById('longitude');
    const nearestStationInput = document.getElementById('nearest_station');

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("La geolocalización no es compatible con este navegador.");
        }
    }

    function showPosition(position) {
        latitudeInput.value = position.coords.latitude;
        longitudeInput.value = position.coords.longitude;
        submitButton.disabled = false;
        
        if (typeof updateMapWithUserLocation === 'function') {
            updateMapWithUserLocation(position.coords.latitude, position.coords.longitude);
        }

        if (typeof findNearestStation === 'function') {
            const nearestStation = findNearestStation(position.coords.latitude, position.coords.longitude);
            nearestStationInput.value = nearestStation;
        }
    }

    function showError(error) {
        let errorMessage;
        switch(error.code) {
            case error.PERMISSION_DENIED:
                errorMessage = "El usuario denegó la solicitud de geolocalización.";
                break;
            case error.POSITION_UNAVAILABLE:
                errorMessage = "La información de ubicación no está disponible.";
                break;
            case error.TIMEOUT:
                errorMessage = "La solicitud para obtener la ubicación del usuario ha expirado.";
                break;
            case error.UNKNOWN_ERROR:
                errorMessage = "Ocurrió un error desconocido.";
                break;
        }
        alert(errorMessage);
    }

    submitButton.disabled = true;
    getLocation();

    form.addEventListener('submit', function(event) {
        if (!latitudeInput.value || !longitudeInput.value) {
            event.preventDefault();
            alert("Por favor, espere a que se determine su ubicación o habilite los servicios de ubicación.");
        }
    });
});
</script>
{% endblock %}
