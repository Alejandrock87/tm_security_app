{% extends "base.html" %}

{% block content %}
<h1>Report an Incident</h1>
<form action="" method="post" novalidate id="incident-form">
    {{ form.hidden_tag() }}
    <div class="mb-3">
        {{ form.incident_type.label(class="form-label") }}
        {{ form.incident_type(class="form-select") }}
        {% for error in form.incident_type.errors %}
        <span class="text-danger">{{ error }}</span>
        {% endfor %}
    </div>
    <div class="mb-3">
        {{ form.description.label(class="form-label") }}
        {{ form.description(rows=5, class="form-control") }}
        {% for error in form.description.errors %}
        <span class="text-danger">{{ error }}</span>
        {% endfor %}
    </div>
    <div class="mb-3">
        <label for="nearest_station" class="form-label">Nearest Transmilenio Station</label>
        <input type="text" id="nearest_station" name="nearest_station" class="form-control" readonly>
    </div>
    <input type="hidden" id="latitude" name="latitude">
    <input type="hidden" id="longitude" name="longitude">
    {{ form.submit(class="btn btn-primary", id="submit-button") }}
</form>

<div id="map" style="height: 400px; margin-top: 20px;"></div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('incident-form');
    const submitButton = document.getElementById('submit-button');
    const latitudeInput = document.getElementById('latitude');
    const longitudeInput = document.getElementById('longitude');
    const nearestStationInput = document.getElementById('nearest_station');

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    function showPosition(position) {
        latitudeInput.value = position.coords.latitude;
        longitudeInput.value = position.coords.longitude;
        submitButton.disabled = false;
        
        // Update map with user's location
        if (typeof updateMapWithUserLocation === 'function') {
            updateMapWithUserLocation(position.coords.latitude, position.coords.longitude);
        }

        // Find and display nearest station
        if (typeof findNearestStation === 'function') {
            const nearestStation = findNearestStation(position.coords.latitude, position.coords.longitude);
            nearestStationInput.value = nearestStation;
        }
    }

    function showError(error) {
        switch(error.code) {
            case error.PERMISSION_DENIED:
                alert("User denied the request for Geolocation.");
                break;
            case error.POSITION_UNAVAILABLE:
                alert("Location information is unavailable.");
                break;
            case error.TIMEOUT:
                alert("The request to get user location timed out.");
                break;
            case error.UNKNOWN_ERROR:
                alert("An unknown error occurred.");
                break;
        }
    }

    // Disable submit button until location is obtained
    submitButton.disabled = true;

    // Get location when the page loads
    getLocation();

    // Prevent form submission if location hasn't been obtained
    form.addEventListener('submit', function(event) {
        if (!latitudeInput.value || !longitudeInput.value) {
            event.preventDefault();
            alert("Please wait for your location to be determined or enable location services.");
        }
    });
});
</script>
{% endblock %}
